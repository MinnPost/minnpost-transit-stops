/*! minnpost-transit-stops - v0.0.0 - 2014-07-15
* https://github.com/minnpost/minnpost-transit-stops
* Copyright (c) 2014 MinnPost; Licensed MIT */

define("helpers",["jquery","underscore"],function(a,b){var c={};return c.overrideBackboneAJAX=function(){Backbone.ajax=function(){var a=arguments;return a[0].dataTypeForce!==!0&&(a[0].dataType="jsonp",a[0].jsonpCallback="mpServerSideCachingHelper"+b.hash(a[0].url)),Backbone.$.ajax.apply(Backbone.$,a)}},c.isMSIE=function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},c.jsonpRequest=function(c,d){return options.dataType="jsonp",options.jsonpCallback="mpServerSideCachingHelper"+b.hash(options.url),d.remoteProxy&&(options.url=options.url+"&callback=mpServerSideCachingHelper",options.url=d.remoteProxy+encodeURIComponent(options.url),options.cache=!0),a.ajax.apply(a,[options])},c.getLocalData=function(d,e){var f=!1,g=[];return d=b.isArray(d)?d:[d],e&&e.paths&&0===e.paths.data.indexOf("http")&&(f=!0),b.each(d,function(b){var d;d=f?c.jsonpRequest({url:proxyPrefix+encodeURI(e.paths.data+b)},e):a.getJSON(e.paths.data+b),g.push(d)}),a.when.apply(a,g)},c.parseQueryString=function(){var a={},c=function(a){return decodeURIComponent(a.replace(/\+/g," "))},d=location.search.substring(1),e=d.split("&");return b.each(e,function(b){var d=b.split("=");d.length>1&&(a[c(d[0])]=c(d[1]))}),a},c}),define("text!templates/application.mustache",[],function(){return'<div class="application-container">\n  <div class="message-container"></div>\n\n  <div class="content-container">\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>Recently, there has been talk about transit stop quality in Minneapolis, specifically how the Northern neighborhoods might have less amenities than other neighborhoods.  So, how do we determine or quanitify stop quality across the city?</p>\n\n        <p>First we need some data.  Fortunately, there is a lot of public, online data for us to start with.  We first grabbed basic stop data for all MetroTransit stops; this included data such as location and some basic amenities like benches and shelters.  MetroTransit also provides boarding data for a number of the stops online.  We had to make a specific request to MetroTransit for data on shelter amentities such as heating and lighting.  And finally, we were able to get recent demographic data for Minneapolis neighborhoods from MN Compass.</p>\n      </div>\n      <div class="column-medium-50">\n\n      </div>\n    </div>\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>There are 87 neighborhoods in Minneapolis.  So, which ones are we talking about when we say North Minneapolis?  Well, the answer can change on who you are talking to, but we are defining them as the Minneapolis Community Areas known as Camden and Near North.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="map" id="map-neighborhoods-north"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>Now that we have intendified our comparison area, we want to make start to make sure that are comparisons are on equal grounds.  First we remove two groups of neighborhoods.  The industrial neighborhoods that have none or very low populations.</p>\n        <p>The second is a bit more subjective.  The layout of the transit system is a hub-spoke layout, meaning that most of the routes end up terminating or going through the hub, which is Downtown in the instance.  So, we remove these as they will end up skewing any comparison we do.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="map" id="map-neighborhoods-outliers"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>Next we can start to look at stop quality.  If we look at just the number of shelters per neighborhood, there is an pretty obvious visual pattern that shows more shelters in the South/West of the city.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="map" id="map-shelters"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>But we want to consider other amenities such as heating, lighting, benches, and signs.  So, let\'s create a stop score based on these factors.  Of course, this is fairly subjective, and we will explore what it means to change the scoring below.</p>\n\n        <p>\n          Has a shelter: 5 points <br />\n          Has a heater: 4 points <br />\n          Has lighting: 3 points <br />\n          Has a bench: 2 points <br />\n          Has a sign: 1 points\n        </p>\n      </div>\n      <div class="column-medium-50">\n        <div class="map" id="map-scores"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>We now have a decent measure of stop quality, but we still haven\'t taken into account that each neighborhood is unique.  Each neighborhood is unique in many ways, but  we need to at the very least adjust for population.  This means we want to look at stop quality per capita for each neightborhood.  Once we do this, it becomes much harder to tell visually if there are specific areas of the city that do or do not have a significant stop qaulity difference.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="map" id="map-score-per-capita"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>Our final step is to run these numbers through some statistical analysis.  We want to compare the northern neighborhoods to the rest of the neighborhoods which means that <a href="http://en.wikipedia.org/wiki/ANOVA" target="_blank">ANOVA</a> (analysis of variance) is most appropriate.  ANOVA is a model that tells us if the average of the groups are the same, statistically speaking.</p>\n\n        <p>\n          All neighborhoods:  {{ formatters.number(meanAll * 1000, 2) }} score per 1,000 residents<br >\n          Northern neighborhoods: {{ formatters.number(meanNorth * 1000, 2) }}<br>\n          Non-Northern neighborhoods: {{ formatters.number(meanNonNorth * 1000, 2) }}\n        </p>\n\n        <p>We know that the averages are indeed different.  But given the all the values and how each neighborhood differs from the next, we need something more soffisticated to ask is this different really our of the norm given the city as a whole.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="xxlarge text-center">\n          .201 : Not significant\n        </div>\n\n        <p><br><br></p>\n        <p>This means that we can\'t say with certianty that the values are significantly different.</p>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>This analysis does not conclude that we shouldn\'t look deeper or that the northern neighborhoods don\'t need better stop quality, it simply means that by just looking at the numbers, we can\'t be certain that the northern neighborhoods have significantly lower stop quality.</p>\n      </div>\n      <div class="column-medium-50">\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>And of course, our methodolgy may not be perfect; maybe there are things we can adjust that moer accurately describes how you view the situation.  For instance, adjust how our score is calculated or how we want to normalize each neighborhood.</p>\n\n        <p><em>Insert sliders and knobs here to play with anaylsis.</em></p>\n      </div>\n      <div class="column-medium-50">\n        <div class="xxlarge text-center">\n          Maybe significant\n        </div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>Originally, the claims were that the northern neighborhoods did not have the same stop quality as the rest of the city, and our analysis above shows that its very difficult to be certain of this.  But, we can still look at other numbers to see if there are indeed neighborhoods that are lacking in stop quality.</p>\n\n        <p>The scatterplot to the right shows the score per capita against the percentage of the non-white population in each neighborhood.  We can see pretty easily that there is not really any correlation between these two variables.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="chart" id="chart-score-non-white"></div>\n      </div>\n    </div>\n\n\n    <div class="row">\n      <div class="column-medium-50">\n        <p>We could also look at score per 1,000 residents against percenage employed.  Again, we don\'t see any real correlation.</p>\n      </div>\n      <div class="column-medium-50">\n        <div class="chart" id="chart-score-employed"></div>\n      </div>\n    </div>\n\n\n  </div>\n\n  <div class="footnote-container">\n    <div class="footnote">\n      <p>Some code, techniques, and data on <a href="https://github.com/minnpost/minnpost-transit-stops" target="_blank">Github</a>.</p>\n\n        <p>Some map data © OpenStreetMap contributors; licensed under the <a href="http://www.openstreetmap.org/copyright" target="_blank">Open Data Commons Open Database License</a>.  Some map design © MapBox; licensed according to the <a href="http://mapbox.com/tos/" target="_blank">MapBox Terms of Service</a>.  Location geocoding provided by <a href="http://www.mapquest.com/" target="_blank">Mapquest</a> and is not guaranteed to be accurate.</p>\n\n    </div>\n  </div>\n</div>\n'}),define("text!templates/map-tooltip.underscore",[],function(){return"<div class=\"general-map-tooltip\">\n  <strong><%= name %></strong>\n\n  <% if (typeof label != 'undefined' && label) { %>\n    <br />\n    <%= label %>: <%= value %>\n  <% } %>\n</div>\n"}),define("minnpost-transit-stops",["jquery","underscore","ractive","ractive-events-tap","topojson","chroma","leaflet","simple-statistics","highcharts","mpConfig","mpFormatters","mpMaps","mpHighcharts","helpers","text!templates/application.mustache","text!templates/map-tooltip.underscore"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=function(c){this.options=b.extend(this.defaultOptions,c),this.el=this.options.el,this.$el=a(this.el),this.$=function(a){return this.$el.find(a)},this.$content=this.$el.find(".content-container"),this.loadApp()};return b.extend(q.prototype,{start:function(){var a=this;this.mapTooltipView=b.template(p),this.mainView=new c({el:this.$el,template:o,data:{originalShelterWeight:5,originalHeatWeight:4,originalLightWeight:3,originalBenchWeight:2,originalSignWeight:1,shelterWeight:5,heatWeight:4,lightWeight:3,benchWeight:2,signWeight:1,formatters:k},partials:{}}),b.delay(function(){a.getData()},800)},getData:function(){var a=this;n.getLocalData("neighborhood-stop-data.topo.json",this.options).done(function(c){a.nDataOutliers=e.feature(c,c.objects["neighborhood-stop-data.geo"]),a.nData=b.clone(a.nDataOutliers),a.nData.features=b.filter(a.nData.features,function(a){return 1!==a.properties.outlier}),a.nNorth=e.merge(c,b.filter(c.objects["neighborhood-stop-data.geo"].geometries,function(a){return a.properties.north})),a.makeStats(),a.makeMaps(),a.makeCharts()})},makeStats:function(){var a=this;this.mainView.set("countShelter",b.reduce(this.nData.features,function(a,b){return a+b.properties.shelter},0)),this.mainView.set("countLight",b.reduce(this.nData.features,function(a,b){return a+b.properties.light},0)),this.mainView.set("countHeat",b.reduce(this.nData.features,function(a,b){return a+b.properties.heat},0)),this.mainView.set("countBench",b.reduce(this.nData.features,function(a,b){return a+b.properties.bench},0)),this.mainView.set("countSign",b.reduce(this.nData.features,function(a,b){return a+b.properties.sign},0)),this.nData.features=b.map(this.nData.features,function(b){return b.properties.originalScore=b.properties.sign*a.mainView.get("originalSignWeight")+b.properties.bench*a.mainView.get("originalBenchWeight")+b.properties.light*a.mainView.get("originalLightWeight")+b.properties.heat*a.mainView.get("originalHeatWeight")+b.properties.shelter*a.mainView.get("originalShelterWeight"),b}),this.mainView.set("meanNorth",h.mean(b.map(b.filter(this.nData.features,function(a){return!!a.properties.north}),function(a){return a.properties.originalScore/a.properties.population}))),this.mainView.set("meanNonNorth",h.mean(b.map(b.filter(this.nData.features,function(a){return!a.properties.north}),function(a){return a.properties.originalScore/a.properties.population}))),this.mainView.set("meanAll",h.mean(b.map(this.nData.features,function(a){return a.properties.originalScore/a.properties.population})))},makeCharts:function(){this.charts={},this.charts.scoreNonWhite=m.makeChart("#chart-score-non-white",a.extend(!0,{},m.scatterOptions,{series:[{name:"Score by Non-white population",data:b.map(this.nData.features,function(a){return[a.properties.non_white_per,a.properties.originalScore/a.properties.population*1e3]})}]})),this.charts.scoreNonWhite=m.makeChart("#chart-score-employed",a.extend(!0,{},m.scatterOptions,{series:[{name:"Score by Employed population",data:b.map(this.nData.features,function(a){return[a.properties.employed_per,a.properties.originalScore/a.properties.population*1e3]})}]}))},makeMaps:function(){var a=this;this.maps={},this.maps.nNorth=this.makeNeighborhoodMap("map-neighborhoods-north",!0,!0,function(a){return b.extend({},l.mapStyle,{fillOpacity:a.properties.north?.9:0})},function(b){return a.mapTooltipView({name:b.properties.Name,label:"Community area",value:b.properties.community_area})}),this.maps.nOutlier=this.makeNeighborhoodMap("map-neighborhoods-outliers",!0,!1,function(a){return b.extend({},l.mapStyle,{fillOpacity:a.properties.outlier?.9:0})},function(b){return a.mapTooltipView({name:b.properties.Name})}),this.maps.shelters={},this.maps.shelters.scale=this.makeColorScale("shelter"),b.extend(this.maps.shelters,this.makeNeighborhoodMap("map-shelters",!1,!0,function(c){return b.extend({},l.mapStyle,{fillOpacity:.75,fillColor:a.maps.shelters.scale(c.properties.shelter)})},function(b){return a.mapTooltipView({name:b.properties.Name,label:"Shelters",value:b.properties.shelter})})),this.maps.scores={},this.maps.scores.scale=this.makeColorScale("originalScore"),b.extend(this.maps.scores,this.makeNeighborhoodMap("map-scores",!1,!0,function(c){return b.extend({},l.mapStyle,{fillOpacity:.75,fillColor:a.maps.scores.scale(c.properties.originalScore)})},function(b){return a.mapTooltipView({name:b.properties.Name,label:"Score",value:k.number(b.properties.originalScore,0)})})),this.maps.scorePerPop={},this.maps.scorePerPop.scale=this.makeColorScale(function(a){return a.properties.originalScore/a.properties.population}),b.extend(this.maps.scorePerPop,this.makeNeighborhoodMap("map-score-per-capita",!1,!0,function(c){return b.extend({},l.mapStyle,{fillOpacity:.75,fillColor:a.maps.scorePerPop.scale(c.properties.originalScore/c.properties.population)})},function(b){return a.mapTooltipView({name:b.properties.Name,label:"Score per 1,000 residents",value:k.number(b.properties.originalScore/b.properties.population*1e3,2)})}))},makeColorScale:function(a){var c;c=b.isFunction(a)?a:function(b){return b.properties[a]};var d=b.min(this.nData.features,c);d=c(d);var e=b.max(this.nData.features,c);return e=c(e),f.scale(["white","green"]).out("hex").mode("lch").domain([d,e],5)},makeNeighborhoodMap:function(a,c,d,e,f){var h,i={},j=c?this.nDataOutliers:this.nData;return i.map=new g.Map(a,l.mapOptions),h=new g.tileLayer("//{s}.tiles.mapbox.com/v3/"+l.mapboxStreetsLightLabels+"/{z}/{x}/{y}.png"),i.map.addLayer(h),i.map.setView(l.minneapolisPoint,8),i.map.removeControl(i.map.attributionControl),i.tooltipControl=new l.TooltipControl,i.map.addControl(i.tooltipControl),i.nLayer=g.geoJson(j,{style:e,onEachFeature:function(a,b){b.on("mouseover",function(c){i.tooltipControl.update(f(a,b,c))}),b.on("mouseout",function(){i.tooltipControl.hide()})}}),i.nLayer.addTo(i.map),d&&g.geoJson(this.nNorth,{style:{fillColor:"transparent",fillOpacity:0,color:"black",strokeWidth:2.5,clickable:!1}}).addTo(i.map),b.delay(function(){i.map.fitBounds(i.nLayer.getBounds()),i.map.invalidateSize()},900),i},defaultOptions:{projectName:"minnpost-transit-stops",remoteProxy:"//mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",el:".minnpost-transit-stops-container",availablePaths:{local:{css:[".tmp/css/main.css"],images:"images/",data:"data/"},build:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","dist/minnpost-transit-stops.libs.min.css","dist/minnpost-transit-stops.latest.min.css"],ie:["dist/minnpost-transit-stops.libs.min.ie.css","dist/minnpost-transit-stops.latest.min.ie.css"],images:"dist/images/",data:"dist/data/"},deploy:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/minnpost-transit-stops.libs.min.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/minnpost-transit-stops.latest.min.css"],ie:["//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/minnpost-transit-stops.libs.min.ie.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/minnpost-transit-stops.latest.min.ie.css"],images:"//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/images/",data:"//s3.amazonaws.com/data.minnpost/projects/minnpost-transit-stops/data/"}}},loadApp:function(){this.determinePaths(),this.getLocalAssests(function(a){this.renderAssests(a),this.start()})},determinePaths:function(){var a;this.options.deployment="deploy",-1!==window.location.host.indexOf("localhost")&&(this.options.deployment="local",a=n.parseQueryString(),b.isObject(a)&&b.isString(a.mpDeployment)&&(this.options.deployment=a.mpDeployment)),this.options.paths=this.options.availablePaths[this.options.deployment]},getLocalAssests:function(b){var c=this;"local"===this.options.deployment?a.getJSON("bower.json",function(a){b.apply(c,[a.dependencyMap])}):b.apply(this,[])},renderAssests:function(c){var d=n.isMSIE()&&n.isMSIE()<=8;b.isObject(c)&&b.each(c,function(c){c.css&&b.each(c.css,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),c.ie&&d&&b.each(c.ie,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')})}),b.each(this.options.paths.css,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),d&&b.each(this.options.paths.ie,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),this.$el.addClass("processed")}}),q}),require(["jquery","minnpost-transit-stops"],function(a,b){a(document).ready(function(){new b})});